{% load static %}

<div class="alert alert-success alert-dismissible fade show" role="alert">
    <h5 class="alert-heading">
        <i class="fa fa-check-circle"></i> Attendance Recorded Successfully!
    </h5>
    
    <p class="mb-2">
        <strong>{{ success_count }}</strong> attendance record{{ success_count|pluralize }} saved for {{ attendance_date|date:"F j, Y" }}.
    </p>
    
    {% if section %}
        <p class="mb-2">Section: <strong>{{ section.name }}</strong></p>
    {% endif %}
    
    {% if todays_records %}
        <hr>
        <h6>Attendance recorded for {{ attendance_date|date:"F j, Y" }}:</h6>
        <div class="row">
            <div class="col-12">
                <ul class="list-unstyled mb-2">
                    {% for record in todays_records %}
                        <li class="mb-1">
                            {% if record.member %}
                                <span class="badge bg-success text-white me-2">Member</span>
                                <strong>{{ record.member }}</strong>
                                {% if record.played_instrument %}
                                    <small class="text-muted ms-2">({{ record.played_instrument.name }})</small>
                                {% elif record.member.primary_instrument %}
                                    <small class="text-muted ms-2">({{ record.member.primary_instrument.name }})</small>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-info text-white me-2">Guest</span>
                                <strong>{{ record.guest_name }}</strong>
                            {% endif %}
                            {% if record.notes %}
                                <small class="text-muted ms-2">({{ record.notes }})</small>
                            {% endif %}
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    {% endif %}
    
    {% if errors %}
        <hr>
        <h6>Errors encountered:</h6>
        <ul class="mb-2">
            {% for error in errors %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% endif %}
    
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>

<script>
(function() {
    // Reset the form but preserve the date field, event type selection, and notes
    const form = document.getElementById('attendanceForm');
    const dateField = document.getElementById('attendance_date');
    const eventNotesField = document.getElementById('event_notes');
    
    // Save current values
    const currentDate = dateField ? dateField.value : null;
    const currentNotes = eventNotesField ? eventNotesField.value : '';
    
    // Find which event_type radio is currently checked
    const checkedEventType = form ? form.querySelector('input[name="event_type"]:checked') : null;
    const currentEventTypeValue = checkedEventType ? checkedEventType.value : 'rehearsal';
    
    if (form) {
        // Reset all member/guest checkboxes and guest text areas
        const checkboxes = form.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => cb.checked = false);
        
        const guestTextareas = form.querySelectorAll('textarea[id^="guest_"]');
        guestTextareas.forEach(ta => ta.value = '');
        
        // Restore preserved fields
        if (dateField) {
            dateField.value = currentDate || '{{ today|date:"Y-m-d" }}';
        }
        
        if (eventNotesField) {
            eventNotesField.value = currentNotes;
        }
        
        // Restore event type selection
        const eventTypeToCheck = form.querySelector(`input[name="event_type"][value="${currentEventTypeValue}"]`);
        if (eventTypeToCheck) {
            eventTypeToCheck.checked = true;
        } else {
            // Fallback: check rehearsal if the selected option no longer exists
            const rehearsalRadio = document.getElementById('event_type_rehearsal');
            if (rehearsalRadio) {
                rehearsalRadio.checked = true;
            }
        }
    }
    
    // Auto-dismiss the alert after 5 seconds
    setTimeout(function() {
        const alert = document.querySelector('.alert-success');
        if (alert) {
            alert.classList.remove('show');
            setTimeout(() => alert.remove(), 150);
        }
    }, 5000);
})();
</script>
